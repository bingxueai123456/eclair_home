<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JWTç¦»çº¿è®¤è¯æ–¹æ¡ˆ - åŠ¨æ€æ—¶åºå›¾æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #1e40af 50%, #1e293b 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .header h1 {
      color: white;
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      color: #bfdbfe;
      font-size: 1.2rem;
    }

    .phase-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .phase-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      background: #475569;
      color: #cbd5e1;
    }

    .phase-btn:hover {
      background: #334155;
    }

    .phase-btn.active {
      background: #3b82f6;
      color: white;
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    }

    .phase-btn.execute.active {
      background: #f97316;
    }

    .diagram-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      padding: 2rem;
      margin-bottom: 1.5rem;
    }

    .participants {
      position: relative;
      height: 120px;
      margin-bottom: 2rem;
    }

    .participant {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 80px;
    }

    .participant.server { left: 110px; }
    .participant.app { left: 360px; }
    .participant.cabinet { left: 610px; }

    .participant-icon {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .participant.server .participant-icon { background: #3b82f6; }
    .participant.app .participant-icon { background: #a855f7; }
    .participant.cabinet .participant-icon { background: #22c55e; }

    .participant-name {
      font-weight: 600;
      color: #334155;
      white-space: nowrap;
    }

    .participant-label {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .offline-indicator {
      font-size: 0.75rem;
      color: #ef4444;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .timeline-area {
      position: relative;
      background: #f8fafc;
      border-radius: 0.5rem;
      padding: 1rem;
      min-height: 1000px; /* æ›´æ”¹ï¼šå¢åŠ é«˜åº¦ä»¥å®¹çº³10ä¸ªæ­¥éª¤ */
    }

    .lifeline {
      position: absolute;
      width: 2px;
      top: 0;
      bottom: 0;
    }

    .lifeline.server { left: 150px; background: #93c5fd; }
    .lifeline.app { left: 400px; background: #d8b4fe; }
    .lifeline.cabinet { left: 650px; background: #86efac; }

    .message {
      position: absolute;
      left: 0;
      right: 0;
      opacity: 0;
      transition: opacity 0.5s;
    }

    .message.visible {
      opacity: 1;
    }

    .message.current {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .arrow-line {
      position: absolute;
      height: 3px;
      top: 0;
    }

    .arrow-line.blue { background: #3b82f6; }
    .arrow-line.purple { background: #a855f7; }
    .arrow-line.green { background: #22c55e; }
    .arrow-line.orange { background: #f97316; }

    .arrow-head {
      position: absolute;
      right: -2px;
      top: -4px;
      width: 0;
      height: 0;
      border-left: 8px solid;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
    }

    .arrow-head.blue { border-left-color: #3b82f6; }
    .arrow-head.purple { border-left-color: #a855f7; }
    .arrow-head.green { border-left-color: #22c55e; }
    .arrow-head.orange { border-left-color: #f97316; }

    .self-message {
      position: absolute;
      width: 60px;
      height: 50px;
      border: 3px solid;
      border-left-color: transparent;
      border-radius: 0 10px 10px 0;
    }

    .self-message.blue { border-color: #3b82f6; border-left-color: transparent; }
    .self-message.orange { border-color: #f97316; border-left-color: transparent; }
    .self-message.green { border-color: #22c55e; border-left-color: transparent; }

    .self-arrow {
      position: absolute;
      left: -2px;
      bottom: -5px;
      width: 0;
      height: 0;
      border-top: 8px solid;
      border-right: 5px solid transparent;
      border-left: 5px solid transparent;
    }

    .self-arrow.blue { border-top-color: #3b82f6; }
    .self-arrow.orange { border-top-color: #f97316; }
    .self-arrow.green { border-top-color: #22c55e; }

    .message-label {
      position: absolute;
      background: white;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 2px solid;
      font-size: 0.9rem;
      font-weight: 600;
      color: #334155;
      white-space: nowrap;
    }

    .message-label.blue { border-color: #3b82f6; }
    .message-label.purple { border-color: #a855f7; }
    .message-label.green { border-color: #22c55e; }
    .message-label.orange { border-color: #f97316; }

    .detail-card {
      background: linear-gradient(135deg, #3b82f6 0%, #a855f7 100%);
      border-radius: 1rem;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      color: white;
    }

    .detail-card-content {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }

    .detail-icon {
      width: 48px;
      height: 48px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .detail-text h3 {
      font-size: 1.25rem;
      margin-bottom: 0.5rem;
    }

    .detail-text p {
      color: #bfdbfe;
      line-height: 1.6;
    }

    .decision-tags {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .decision-tag {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
    }

    .decision-tag.success {
      background: rgba(34, 197, 94, 0.3);
      color: #86efac;
    }

    .decision-tag.fail {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .control-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .control-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .control-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .control-btn.play {
      background: #22c55e;
      color: white;
    }

    .control-btn.pause {
      background: #eab308;
      color: white;
    }

    .control-btn.reset {
      background: #64748b;
      color: white;
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .feature-card {
      backdrop-filter: blur(10px);
      border-radius: 0.75rem;
      padding: 1.5rem;
      border: 1px solid;
    }

    .feature-card.security {
      background: rgba(59, 130, 246, 0.2);
      border-color: #93c5fd;
    }

    .feature-card.offline {
      background: rgba(34, 197, 94, 0.2);
      border-color: #86efac;
    }

    .feature-card.time {
      background: rgba(168, 85, 247, 0.2);
      border-color: #d8b4fe;
    }

    .feature-card h4 {
      color: white;
      font-size: 1.1rem;
      margin: 0.75rem 0 0.5rem 0;
    }

    .feature-card p {
      color: #bfdbfe;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    svg {
      width: 48px;
      height: 48px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ ‡é¢˜ --><div class="header">
      <h1>JWTç¦»çº¿è®¤è¯æ–¹æ¡ˆ</h1>
      <p>éå¯¹ç§°åŠ å¯†çš„ç¦»çº¿å‡­è¯æ¼”ç¤º</p>
    </div>

    <!-- é˜¶æ®µåˆ‡æ¢ --><div class="phase-buttons">
      <button class="phase-btn active" onclick="switchPhase(event, 'prepare')">å‡†å¤‡é˜¶æ®µ (åœ¨çº¿)</button>
      <button class="phase-btn execute" onclick="switchPhase(event, 'execute-online')">æ‰§è¡Œé˜¶æ®µ (æŸœæœºç¦»çº¿+æœåŠ¡å™¨åœ¨çº¿)</button>
      <button class="phase-btn execute" onclick="switchPhase(event, 'execute')">æ‰§è¡Œé˜¶æ®µ (æŸœæœºç¦»çº¿+æœåŠ¡å™¨å®•æœº)</button>
    </div>

    <!-- æ—¶åºå›¾ --><div class="diagram-container">
      <!-- å‚ä¸è€… --><div class="participants">
        <div class="participant server">
          <div class="participant-icon">
            <svg fill="white" viewBox="0 0 24 24" stroke="white" stroke-width="1.5">
              <rect x="4" y="4" width="16" height="4" rx="1" />
              <rect x="4" y="12" width="16" height="4" rx="1" />
              <rect x="4" y="20" width="16" height="4" rx="1" />
            </svg>
          </div>
          <span class="participant-name">æœåŠ¡å™¨</span>
          <span class="participant-label">Server</span>
          <span class="offline-indicator" id="serverDownIndicator" style="display:none;">ğŸ”´ å®•æœºçŠ¶æ€</span>
        </div>

        <div class="participant app">
          <div class="participant-icon">
            <svg fill="white" viewBox="0 0 24 24" stroke="white" stroke-width="2">
              <rect x="7" y="2" width="10" height="20" rx="2" />
              <line x1="11" y1="18" x2="13" y2="18" />
            </svg>
          </div>
          <span class="participant-name">ç”¨æˆ·APP</span>
          <span class="participant-label">Mobile App</span>
        </div>

        <div class="participant cabinet">
          <div class="participant-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
          </div>
          <span class="participant-name">æ¢ç”µæŸœ</span>
          <span class="participant-label">Cabinet</span>
          <span class="offline-indicator" id="offlineIndicator" style="display:none;">ğŸ”´ ç¦»çº¿çŠ¶æ€</span>
        </div>
      </div>

      <!-- æ—¶åºå›¾åŒºåŸŸ --><div class="timeline-area" id="timelineArea">
        <div class="lifeline server"></div>
        <div class="lifeline app"></div>
        <div class="lifeline cabinet"></div>
        <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  --></div>
    </div>

    <!-- è¯¦æƒ…å¡ç‰‡ --><div class="detail-card" id="detailCard">
      <div class="detail-card-content">
        <div class="detail-icon" id="detailIcon">ğŸ”’</div>
        <div class="detail-text">
          <h3 id="detailTitle">å‡†å¤‡å¼€å§‹æ¼”ç¤º</h3>
          <p id="detailDescription">ç‚¹å‡»"æ’­æ”¾"æŒ‰é’®å¼€å§‹æ¼”ç¤ºJWTç¦»çº¿è®¤è¯æµç¨‹</p>
          <div id="decisionTags"></div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® --><div class="controls">
      <button class="control-btn play" onclick="play()">
        â–¶ æ’­æ”¾
      </button>
      <button class="control-btn pause" onclick="pause()" disabled>
        â¸ æš‚åœ
      </button>
      <button class="control-btn reset" onclick="reset()">
        â†» é‡ç½®
      </button>
    </div>

    <!-- ç‰¹æ€§å¡ç‰‡ --><div class="features">
      <div class="feature-card security">
        <svg fill="none" viewBox="0 0 24 24" stroke="#93c5fd" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        <h4>é«˜å®‰å…¨æ€§</h4>
        <p>éå¯¹ç§°åŠ å¯†ï¼Œç§é’¥ä¸ç¦»å¼€æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¼ªé€ å‡­è¯</p>
      </div>
      <div class="feature-card offline">
        <svg fill="none" viewBox="0 0 24 24" stroke="#86efac" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        <h4>çœŸæ­£ç¦»çº¿</h4>
        <p>æŸœæœºå®Œå…¨ç¦»çº¿éªŒè¯ï¼Œæ— éœ€è”ç½‘ï¼Œç§’çº§å“åº”</p>
      </div>
      <div class="feature-card time">
        <svg fill="none" viewBox="0 0 24 24" stroke="#d8b4fe" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <h4>æ—¶æ•ˆæ§åˆ¶</h4>
        <p>JWTå†…ç½®è¿‡æœŸæ—¶é—´ï¼Œè‡ªåŠ¨æ§åˆ¶æˆæƒæœ‰æ•ˆæœŸ</p>
      </div>
    </div>
  </div>

  <script>
    const prepareSteps = [
      { id: 1, from: 'server', to: 'server', action: 'ç”Ÿæˆå¯†é’¥å¯¹', detail: 'æœåŠ¡å™¨ç§é’¥(ä¿å¯†) + æœåŠ¡å™¨å…¬é’¥(å…¬å¼€)', color: 'blue', icon: 'ğŸ”' },
      { id: 2, from: 'server', to: 'cabinet', action: 'é¢„ç½®å…¬é’¥', detail: 'æ¢ç”µæŸœå‡ºå‚æ—¶å†…ç½®æœåŠ¡å™¨å…¬é’¥', color: 'green', icon: 'ğŸ“¦' },
      { id: 3, from: 'app', to: 'server', action: 'ç”¨æˆ·ç™»å½•è¯·æ±‚', detail: 'APPåœ¨çº¿ï¼Œå‘æœåŠ¡å™¨è¯·æ±‚ç¦»çº¿å‡­è¯', color: 'purple', icon: 'ğŸ“±' },
      { id: 4, from: 'server', to: 'server', action: 'éªŒè¯èº«ä»½&å¥—é¤', detail: 'æ£€æŸ¥ç”¨æˆ·æƒé™ï¼Œå¥—é¤æœ‰æ•ˆæœŸè‡³2025-11-30', color: 'blue', icon: 'âœ…' },
      { id: 5, from: 'server', to: 'server', action: 'ç”ŸæˆJWTå¹¶ç­¾å', detail: '{"userID":"user_A_123","expiry":"2025-11-30"}\nä½¿ç”¨æœåŠ¡å™¨ç§é’¥ç­¾å', color: 'blue', icon: 'ğŸ”' },
      { id: 6, from: 'server', to: 'app', action: 'ä¸‹å‘å·²ç­¾åJWT', detail: 'APPæœ¬åœ°å®‰å…¨å­˜å‚¨å‡­è¯', color: 'green', icon: 'âœ…' }
    ];

    const executeStepsOnline = [
      { id: 7, from: 'app', to: 'cabinet', action: 'è“ç‰™è¿æ¥', detail: 'APPé€šè¿‡è“ç‰™è¿æ¥æ¢ç”µæŸœ(æŸœæœºç¦»çº¿)', color: 'purple', icon: 'ğŸ“±' },
      { id: 8, from: 'app', to: 'cabinet', action: 'å‘é€JWTå‡­è¯', detail: 'ä¼ è¾“å·²ç­¾åçš„ç¦»çº¿å‡­è¯', color: 'purple', icon: 'ğŸ“¦' },
      { id: 9, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤ä¸€ï¼šéªŒè¯ç­¾å', detail: 'ä½¿ç”¨é¢„ç½®çš„æœåŠ¡å™¨å…¬é’¥éªŒç­¾', color: 'orange', icon: 'ğŸ”', hasDecision: true },
      { id: 10, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤äºŒï¼šè¯»å–æˆæƒä¿¡æ¯', detail: 'ç­¾åéªŒè¯é€šè¿‡ï¼è¯»å–userIDå’Œexpiry', color: 'green', icon: 'âœ…' },
      { id: 11, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤ä¸‰ï¼šéªŒè¯æ—¶æ•ˆ', detail: 'æ£€æŸ¥å½“å‰æ—¶é—´ < expiryè¿‡æœŸæ—¶é—´', color: 'orange', icon: 'â°', hasDecision: true },
      { id: 12, from: 'cabinet', to: 'app', action: 'åŒæ­¥æŸœæœºå½“å‰ç¡¬ä»¶å±æ€§', detail: 'æ¢ç”µæŸœå°†ç”µæ± çŠ¶æ€ã€ä»“ä½ä¿¡æ¯ç­‰æ•°æ®å‘é€åˆ°APP', color: 'green', icon: 'ğŸ“Š' },
      { id: 13, from: 'app', to: 'server', action: 'ä¸Šä¼ æ•°æ®åˆ°æœåŠ¡å™¨', detail: 'APPå°†æŸœæœºç¡¬ä»¶å±æ€§åŒæ­¥åˆ°æœåŠ¡å™¨', color: 'purple', icon: 'â˜ï¸' },
      { id: 14, from: 'server', to: 'app', action: 'ä¸‹å‘æ¢ç”µè“ç‰™æŒ‡ä»¤', detail: 'æœåŠ¡å™¨ç”Ÿæˆå¹¶ä¸‹å‘å¼€é—¨æŒ‡ä»¤åˆ°APP', color: 'blue', icon: 'ğŸ“¡' },
      { id: 15, from: 'app', to: 'cabinet', action: 'è½¬å‘æŒ‡ä»¤åˆ°æ¢ç”µæŸœ', detail: 'APPé€šè¿‡è“ç‰™å°†æŒ‡ä»¤è½¬å‘ç»™æ¢ç”µæŸœ', color: 'purple', icon: 'ğŸ“²' },
      { id: 16, from: 'cabinet', to: 'cabinet', action: 'âœ… æ‰“å¼€æŸœé—¨', detail: 'æ‰§è¡Œå¼€é—¨æŒ‡ä»¤ï¼Œè®°å½•ï¼š[æ—¶é—´] user_A_123 æ¢ç”µæˆåŠŸ', color: 'green', icon: 'ğŸšª' }
    ];

    const executeSteps = [
      { id: 7, from: 'app', to: 'cabinet', action: 'è“ç‰™è¿æ¥', detail: 'APPé€šè¿‡è“ç‰™è¿æ¥æ¢ç”µæŸœ(æœåŠ¡å™¨å®•æœº)', color: 'purple', icon: 'ğŸ“±' },
      { id: 8, from: 'app', to: 'cabinet', action: 'å‘é€JWTå‡­è¯', detail: 'ä¼ è¾“å·²ç­¾åçš„ç¦»çº¿å‡­è¯', color: 'purple', icon: 'ğŸ“¦' },
      { id: 9, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤ä¸€ï¼šéªŒè¯ç­¾å', detail: 'ä½¿ç”¨é¢„ç½®çš„æœåŠ¡å™¨å…¬é’¥éªŒç­¾', color: 'orange', icon: 'ğŸ”', hasDecision: true },
      { id: 10, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤äºŒï¼šè¯»å–æˆæƒä¿¡æ¯', detail: 'ç­¾åéªŒè¯é€šè¿‡ï¼è¯»å–userIDå’Œexpiry', color: 'green', icon: 'âœ…' },
      { id: 11, from: 'cabinet', to: 'cabinet', action: 'æ­¥éª¤ä¸‰ï¼šéªŒè¯æ—¶æ•ˆ', detail: 'æ£€æŸ¥å½“å‰æ—¶é—´ < expiryè¿‡æœŸæ—¶é—´', color: 'orange', icon: 'â°', hasDecision: true },
      { id: 12, from: 'cabinet', to: 'app', action: 'âœ… é‰´æƒé€šè¿‡ï¼å¼€é—¨', detail: 'è®°å½•ç¦»çº¿æ—¥å¿—ï¼š[æ—¶é—´] user_A_123 æ¢ç”µæˆåŠŸ', color: 'green', icon: 'âœ…' }
    ];

    let currentPhase = 'prepare';
    let currentStep = 0;
    let isPlaying = false;
    let timer = null;

    function getSteps() {
      if (currentPhase === 'prepare') return prepareSteps;
      if (currentPhase === 'execute-online') return executeStepsOnline;
      return executeSteps;
    }

    function switchPhase(event, phase) {
      currentPhase = phase;
      currentStep = 0;
      isPlaying = false;
      clearTimeout(timer);

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.phase-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // æ˜¾ç¤º/éšè—ç¦»çº¿æŒ‡ç¤ºå™¨
      const isExecutePhase = phase === 'execute' || phase === 'execute-online';
      document.getElementById('offlineIndicator').style.display = isExecutePhase ? 'block' : 'none';
      document.getElementById('serverDownIndicator').style.display = phase === 'execute' ? 'block' : 'none';

      // é‡ç½®è¯¦æƒ…å¡
      updateDetailCard();
      
      // æ¸…ç©ºå¹¶é‡æ–°æ¸²æŸ“æ—¶åºå›¾
      renderTimeline();
    }

    function renderTimeline() {
      const area = document.getElementById('timelineArea');
      // ä¿ç•™ç”Ÿå‘½çº¿
      const lifelines = area.querySelectorAll('.lifeline');
      area.innerHTML = '';
      lifelines.forEach(line => area.appendChild(line));

      const steps = getSteps();
      // æ ¹æ®æ­¥éª¤æ•°é‡åŠ¨æ€è°ƒæ•´é—´è·
      const stepVerticalSpacing = steps.length > 8 ? 75 : 90;
      
      steps.forEach((step, index) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.style.top = (40 + index * stepVerticalSpacing) + 'px';
        messageDiv.id = `message-${index}`;

        if (step.from === step.to) {
          // è‡ªè°ƒç”¨æ¶ˆæ¯
          const selfMsg = document.createElement('div');
          selfMsg.className = `self-message ${step.color}`;
          const pos = step.from === 'server' ? 150 : step.from === 'app' ? 400 : 650;
          selfMsg.style.left = pos + 'px';
          
          const arrow = document.createElement('div');
          arrow.className = `self-arrow ${step.color}`;
          selfMsg.appendChild(arrow);
          messageDiv.appendChild(selfMsg);

          const label = document.createElement('div');
          label.className = `message-label ${step.color}`;
          label.textContent = step.action;
          label.style.left = (pos + 70) + 'px';
          label.style.top = '10px';
          messageDiv.appendChild(label);
        } else {
          // æ­£å¸¸æ¶ˆæ¯
          const fromPos = step.from === 'server' ? 150 : step.from === 'app' ? 400 : 650;
          const toPos = step.to === 'server' ? 150 : step.to === 'app' ? 400 : 650;
          const left = Math.min(fromPos, toPos);
          const width = Math.abs(toPos - fromPos);

          const line = document.createElement('div');
          line.className = `arrow-line ${step.color}`;
          line.style.left = left + 'px';
          line.style.width = width + 'px';
          
          const arrowHead = document.createElement('div');
          arrowHead.className = `arrow-head ${step.color}`;
          if (fromPos > toPos) {
            arrowHead.style.right = 'auto';
            arrowHead.style.left = '-2px';
            arrowHead.style.transform = 'rotate(180deg)';
          }
          line.appendChild(arrowHead);
          messageDiv.appendChild(line);

          const label = document.createElement('div');
          label.className = `message-label ${step.color}`;
          label.textContent = step.action;
          label.style.left = ((fromPos + toPos) / 2 - 80) + 'px';
          label.style.top = '-30px';
          messageDiv.appendChild(label);
        }

        area.appendChild(messageDiv);

        // æ˜¾ç¤ºå·²å®Œæˆçš„æ­¥éª¤
        if (index <= currentStep) {
          setTimeout(() => {
            messageDiv.classList.add('visible');
            if (index === currentStep) {
              messageDiv.classList.add('current');
            }
          }, 50);
        }
      });
    }

    function updateDetailCard() {
      const steps = getSteps();
      const step = steps[currentStep];
      
      document.getElementById('detailIcon').textContent = step?.icon || 'ğŸ”’';
      document.getElementById('detailTitle').textContent = 
        `æ­¥éª¤ ${currentStep + 1}/${steps.length}: ${step?.action || 'å‡†å¤‡å¼€å§‹'}`;
      document.getElementById('detailDescription').textContent = 
        step?.detail || 'ç‚¹å‡»"æ’­æ”¾"æŒ‰é’®å¼€å§‹æ¼”ç¤º';

      const tagsDiv = document.getElementById('decisionTags');
      tagsDiv.innerHTML = '';
      
      if (step?.hasDecision) {
        tagsDiv.innerHTML = `
          <div class="decision-tag success">âœ“ é€šè¿‡ â†’ ç»§ç»­</div>
          <div class="decision-tag fail">âœ— å¤±è´¥ â†’ æ‹’ç»</div>
        `;
      }
    }

    function play() {
      const steps = getSteps();
      if (currentStep >= steps.length - 1) {
        reset(); // å¦‚æœåœ¨æœ€åä¸€æ­¥ï¼Œé‡ç½®åŠ¨ç”»
      } else if (!isPlaying) { // å¦‚æœä¸åœ¨æ’­æ”¾çŠ¶æ€ï¼Œä»å½“å‰æ­¥å¼€å§‹æ’­æ”¾
         isPlaying = true;
         document.querySelector('.control-btn.play').disabled = true;
         document.querySelector('.control-btn.pause').disabled = false;
         // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ’­æ”¾æˆ–è€…ä»æš‚åœæ¢å¤ï¼Œç«‹å³æ˜¾ç¤ºå½“å‰æ­¥éª¤ï¼Œç„¶åç­‰å¾… 2 ç§’è¿›å…¥ä¸‹ä¸€æ­¥
         renderTimeline();
         updateDetailCard();
         timer = setTimeout(nextStep, 2000);
         return;
      }
      // å¦‚æœå·²ç»åœ¨æ’­æ”¾ï¼ŒplayæŒ‰é’®ä¸åº”è¯¥è¢«ç‚¹å‡»ï¼Œä½†ä¸ºé˜²æ­¢æ„å¤–ï¼Œè¿™é‡Œä¸åšæ“ä½œ
    }

    function nextStep() {
      if (!isPlaying) return;

      const steps = getSteps();
      
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨æœ€åä¸€æ­¥
      if (currentStep >= steps.length - 1) {
        pause(); // åˆ°è¾¾ç»ˆç‚¹ï¼Œåœæ­¢æ’­æ”¾
        return;
      }

      currentStep++;
      renderTimeline();
      updateDetailCard();

      timer = setTimeout(nextStep, 2000);
    }

    function pause() {
      isPlaying = false;
      clearTimeout(timer);
      document.querySelector('.control-btn.play').disabled = false;
      document.querySelector('.control-btn.pause').disabled = true;
    }

    function reset() {
      isPlaying = false;
      clearTimeout(timer);
      currentStep = 0;
      renderTimeline();
      updateDetailCard();
      document.querySelector('.control-btn.play').disabled = false;
      document.querySelector('.control-btn.pause').disabled = true;
    }

    // åˆå§‹åŒ–
    renderTimeline();
    updateDetailCard();
  </script>
</body>
</html>